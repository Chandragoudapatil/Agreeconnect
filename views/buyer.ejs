<!DOCTYPE html>
<html>

<head>
  <title>Buyer Dashboard</title>
  <link rel="stylesheet" href="/css/dashboard.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .dashboard-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
      margin-top: 20px;
    }

    .chart-container {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .notifications-panel {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      max-height: 400px;
      overflow-y: auto;
    }

    .notification-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      display: flex;
      flex-direction: column;
    }

    .notification-item:last-child {
      border-bottom: none;
    }

    .notif-type {
      font-size: 0.8rem;
      font-weight: bold;
      color: #666;
    }

    .notif-msg {
      font-size: 0.95rem;
      color: #333;
    }

    .notif-time {
      font-size: 0.75rem;
      color: #999;
      margin-top: 3px;
    }
  </style>
</head>

<body class="buyer">

  <div class="container">
    <div class="sidebar">
      <h2 class="highlight">AgreeConnect</h2>
      <a href="/buyer" class="active">Dashboard</a>
      <a href="/buyer/products">Browse Products</a>
      <a href="/buyer/bids">My Bids</a>
      <a href="/buyer/orders">Orders</a>
      <a href="/cart">My Cart</a>
      <a href="/buyer/profile">Profile</a>
      <a class="logout" href="/auth/logout">Logout</a>
    </div>

    <div class="main">
      <div class="topbar">
        <h2>Dashboard</h2>
        <span>Welcome, <%= user ? user.name : 'User' %></span>
      </div>

      <!-- Stats Row -->
      <div class="cards">
        <div class="stat-card">
          <div class="stat-label">Active Bids</div>
          <div class="stat-number">
            <%= stats.activeBids || 0 %>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Won Auctions</div>
          <div class="stat-number">
            <%= stats.wonBids || 0 %>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Orders</div>
          <div class="stat-number">
            <%= stats.totalOrders || 0 %>
          </div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Total Spent</div>
          <div class="stat-number">â‚¹<%= stats.totalSpent || 0 %>
          </div>
        </div>
      </div>

      <div class="dashboard-grid">
        <!-- Analytics Chart -->
        <div class="chart-container">
          <h3>Activity Overview</h3>
          <canvas id="activityChart"></canvas>
        </div>

        <!-- Notifications -->
        <div class="notifications-panel">
          <h3>Recent Notifications ðŸ””</h3>
          <% if(typeof notifications !=='undefined' && notifications.length> 0) { %>
            <% notifications.forEach(n=> { %>
              <div class="notification-item">
                <span class="notif-text">
                  <%= n.message %>
                </span>
                <span class="notif-time">
                  <%= new Date(n.createdAt).toLocaleString() %>
                </span>
              </div>
              <% }) %>
                <% } else { %>
                  <p style="color:#777; font-style:italic;">No new notifications</p>
                  <% } %>
        </div>
      </div>

      <!-- Recent Opportunities -->
      <div style="margin-top: 30px;">
        <h3>Latest Opportunities</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Product</th>
                <th>Current Price</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <% if(typeof products !=='undefined' ) { %>
                <% products.forEach(p=> { %>
                  <tr>
                    <td>
                      <%= p.name %>
                    </td>
                    <td>â‚¹<%= p.currentBid || p.basePrice %>
                    </td>
                    <td>
                      <a href="/buyer/products" style="text-decoration:none; color:#1e88e5; font-weight:bold;">View</a>
                    </td>
                  </tr>
                  <% }) %>
                    <% } %>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <script>
    // simple chart
    const ctx = document.getElementById('activityChart').getContext('2d');
    const myChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['Active Bids', 'Won', 'Orders'],
        datasets: [{
          label: 'Count',
          data: [<%= stats.activeBids %>, <%= stats.wonBids %>, <%= stats.totalOrders %>],
          backgroundColor: [
            'rgba(54, 162, 235, 0.6)',
            'rgba(75, 192, 192, 0.6)',
            'rgba(255, 206, 86, 0.6)'
          ],
          borderColor: [
            'rgba(54, 162, 235, 1)',
            'rgba(75, 192, 192, 1)',
            'rgba(255, 206, 86, 1)'
          ],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: {
            beginAtZero: true
          }
        }
      }
    });
  </script>

</body>

</html>